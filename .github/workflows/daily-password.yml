name: Generate Daily Password

on:
  schedule:
    # 每天UTC时间00:00（北京时间08:00）运行
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  generate-password:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Generate password
        id: generate
        run: |
          # 生成6位随机密码（数字+字母）
          PASSWORD=$(openssl rand -hex 3 | tr '[:lower:]' '[:upper:]' | head -c 6)
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "Generated password: $PASSWORD"
      
      - name: Get today's date
        id: date
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT
      
      - name: Update passwords.json
        run: |
          python3 << EOF
          import json
          from datetime import datetime, timedelta
          
          # 读取现有文件
          try:
              with open('passwords.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
          except:
              data = {"lifetime_codes": {}, "daily_codes": {}}
          
          # 获取今天的日期和密码
          today = datetime.now().strftime('%Y-%m-%d')
          password = "${{ steps.generate.outputs.password }}"
          
          # 更新daily_codes
          if 'daily_codes' not in data:
              data['daily_codes'] = {}
          data['daily_codes'][today] = password
          
          # 只保留最近7天的密码
          dates = sorted(data['daily_codes'].keys(), reverse=True)
          if len(dates) > 7:
              for old_date in dates[7:]:
                  del data['daily_codes'][old_date]
          
          # 保存文件
          with open('passwords.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          EOF
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add passwords.json
          git commit -m "Update daily password for ${{ steps.date.outputs.date }}" || exit 0
          git push
